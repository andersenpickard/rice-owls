<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rice Events Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00264d;
            --accent: #d4af37;
            --light-bg: #f8f9fa;
            --border: #e0e0e0;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        body {
            font-family: 'Georgia', 'Garamond', serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #ffffff 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-size: 3rem;
            color: var(--primary);
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.1rem;
            color: var(--text-light);
            font-style: italic;
            font-weight: 300;
        }

        .search-panel {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--accent);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Georgia', serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        button {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--primary) 0%, #003d73 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 38, 77, 0.2);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 38, 77, 0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 15px;
        }

        .results-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .results-count {
            font-size: 1rem;
            color: var(--text-light);
            font-style: italic;
        }

        .events-container {
            display: grid;
            gap: 20px;
        }

        .event-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
        }

        .event-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .event-title {
            font-size: 1.3rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .event-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.85rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .distance {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, #003d73 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #3c3;
        }

        .warning {
            background: #ffe;
            color: #cc3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #cc3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-status {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 10px;
            text-align: center;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .search-panel {
                padding: 25px;
            }

            .input-wrapper {
                flex-direction: column;
            }

            input[type="text"],
            input[type="number"],
            button {
                width: 100%;
            }

            .event-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rice Athletic Events Finder</h1>
            <p class="tagline">Discover upcoming Rice University events near you!</p>
        </header>

        <div class="search-panel">
            <form id="searchForm">
                <div class="form-group">
                    <label for="zipInput">ZIP Code</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="zipInput" 
                            placeholder="e.g., 77005" 
                            maxlength="5"
                            required
                        >
                        <input 
                            type="number" 
                            id="radiusInput" 
                            value="25" 
                            min="1"
                            max="500"
                            placeholder="Search radius (miles)"
                        >
                        <button type="submit" id="searchBtn">Find Events</button>
                    </div>
                </div>
            </form>
            <div class="data-status" id="dataStatus"></div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h2>Upcoming Events</h2>
                <span class="results-count" id="eventCount"></span>
            </div>
            <div class="events-container" id="eventsContainer"></div>
        </div>

        <div id="messageContainer"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        // Convert webcal to https
        const ICS_FILE_URL = 'https://riceowls.com/api/v2/Calendar/subscribe?type=ics';

        let allEvents = [];
        let lastFetchTime = null;

        // Haversine formula to calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Parse ICS file
        function parseICS(icsContent) {
            const events = [];
            const lines = icsContent.split('\n');
            let currentEvent = {};

            for (let line of lines) {
                line = line.trim();

                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT') {
                    if (currentEvent.title && currentEvent.dtstart) {
                        events.push(currentEvent);
                    }
                } else if (line.startsWith('SUMMARY:')) {
                    currentEvent.title = line.substring(8).trim();
                } else if (line.startsWith('LOCATION:')) {
                    // Unescape commas and other escaped characters
                    let location = line.substring(9).trim();
                    location = location.replace(/\\,/g, ',').replace(/\\n/g, '\n');
                    currentEvent.location = location;
                } else if (line.startsWith('DTSTART')) {
                    const match = line.match(/DTSTART[^:]*:(.+)/);
                    if (match) {
                        currentEvent.dtstart = match[1].trim();
                    }
                } else if (line.startsWith('DESCRIPTION:')) {
                    currentEvent.description = line.substring(12).trim();
                } else if (line.startsWith('GEO:')) {
                    const match = line.match(/GEO:([^,;]+)[,;](.+)/);
                    if (match) {
                        currentEvent.lat = parseFloat(match[1]);
                        currentEvent.lon = parseFloat(match[2]);
                    }
                }
            }

            return events;
        }

        // Geocode location name to coordinates
        async function geocodeLocation(location) {
            if (!location) return null;
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error for', location, ':', error);
                return null;
            }
        }

        // Convert ICS datetime to formatted date/time
        function formatDateTime(dtstart) {
            if (!dtstart) return { date: 'N/A', time: 'N/A' };

            let date;

            if (dtstart.includes('T')) {
                const [datePart, timePart] = dtstart.split('T');
                const year = datePart.substring(0, 4);
                const month = datePart.substring(4, 6);
                const day = datePart.substring(6, 8);
                const hours = timePart.substring(0, 2);
                const minutes = timePart.substring(2, 4);

                date = new Date(`${year}-${month}-${day}T${hours}:${minutes}:00Z`);
            } else {
                const year = dtstart.substring(0, 4);
                const month = dtstart.substring(4, 6);
                const day = dtstart.substring(6, 8);
                date = new Date(`${year}-${month}-${day}`);
            }

            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let formattedTime = 'All Day';
            if (dtstart.includes('T')) {
                formattedTime = date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }

            return { date: formattedDate, time: formattedTime };
        }

        // Geocode a ZIP code to coordinates
        async function geocodeZIP(zipcode) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?postalcode=${zipcode}&country=USA&format=json&limit=1`
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Helper function to parse datetime for filtering
        function parseDateTime(dtstart) {
            if (!dtstart) return { date: 'Invalid' };

            if (dtstart.includes('T')) {
                const [datePart, timePart] = dtstart.split('T');
                const year = datePart.substring(0, 4);
                const month = datePart.substring(4, 6);
                const day = datePart.substring(6, 8);
                return { date: `${year}-${month}-${day}` };
            } else {
                const year = dtstart.substring(0, 4);
                const month = dtstart.substring(4, 6);
                const day = dtstart.substring(6, 8);
                return { date: `${year}-${month}-${day}` };
            }
        }

        // Fetch and parse ICS file from GitHub
        async function fetchEvents() {
            try {
                const response = await fetch(ICS_FILE_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const icsContent = await response.text();
                let parsedEvents = parseICS(icsContent);

                console.log(`Found ${parsedEvents.length} total events. Geocoding locations...`);
                
                // Geocode events that don't have coordinates
                const geocodedEvents = [];
                for (const event of parsedEvents) {
                    if (!event.lat || !event.lon) {
                        if (event.location) {
                            console.log(`Geocoding: ${event.location}`);
                            const coords = await geocodeLocation(event.location);
                            if (coords) {
                                event.lat = coords.lat;
                                event.lon = coords.lon;
                                console.log(`‚úì ${event.location} -> ${coords.lat}, ${coords.lon}`);
                            } else {
                                console.log(`‚úó Could not geocode: ${event.location}`);
                            }
                        }
                    }
                    geocodedEvents.push(event);
                }

                // Filter to future events only
                const now = new Date();
                console.log(`Current date: ${now.toISOString()}`);
                
                allEvents = geocodedEvents
                    .filter(event => {
                        if (!event.lat || !event.lon) return false;
                        const eventDate = parseDateTime(event.dtstart);
                        const eventDateObj = new Date(eventDate.date);
                        const isFuture = eventDateObj >= now;
                        if (!isFuture) {
                            console.log(`Filtered out past event: ${event.title} (${eventDate.date})`);
                        }
                        return isFuture;
                    })
                    .sort((a, b) => {
                        const dateA = new Date(parseDateTime(a.dtstart).date);
                        const dateB = new Date(parseDateTime(b.dtstart).date);
                        return dateA - dateB;
                    });

                console.log(`Successfully loaded ${allEvents.length} future events with coordinates`);
                lastFetchTime = new Date().toLocaleTimeString();
                updateDataStatus();
                return allEvents;
            } catch (error) {
                console.error('Error fetching ICS file:', error);
                showMessage(`Failed to load events: ${error.message}`, 'error');
                return [];
            }
        }

        // Display message
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 6000);
        }

        // Update data status
        function updateDataStatus() {
            const status = document.getElementById('dataStatus');
            if (allEvents.length > 0) {
                status.textContent = `‚úì ${allEvents.length} events loaded ${lastFetchTime ? `(Last updated: ${lastFetchTime})` : ''}`;
            }
        }

        // Display results
        function displayResults(events, zipcode, radius) {
            const resultsSection = document.getElementById('resultsSection');
            const eventsContainer = document.getElementById('eventsContainer');
            const eventCount = document.getElementById('eventCount');

            if (events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No Events Found</h3>
                        <p>Try increasing your search radius or checking back later for more events in your area.</p>
                    </div>
                `;
            } else {
                eventsContainer.innerHTML = events.map(event => {
                    const { date, time } = formatDateTime(event.dtstart);
                    return `
                        <div class="event-card">
                            <div class="event-title">${event.title}</div>
                            <div class="event-meta">
                                <div class="meta-item">
                                    <span class="meta-label">üìç Location</span>
                                    <span class="meta-value">${event.location || 'TBA'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">üìÖ Date</span>
                                    <span class="meta-value">${date}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">üïê Time</span>
                                    <span class="meta-value">${time}</span>
                                </div>
                            </div>
                            <span class="distance">üìç ${event.distance.toFixed(1)} miles away</span>
                        </div>
                    `;
                }).join('');
            }

            eventCount.textContent = `${events.length} ${events.length === 1 ? 'event' : 'events'} found`;
            resultsSection.style.display = 'block';
        }

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (allEvents.length === 0) {
                showMessage('Events data not loaded yet. Please refresh the page.', 'warning');
                return;
            }

            const zipInput = document.getElementById('zipInput').value.trim();
            const radius = parseFloat(document.getElementById('radiusInput').value);
            const searchBtn = document.getElementById('searchBtn');

            if (!/^\d{5}$/.test(zipInput)) {
                showMessage('Please enter a valid 5-digit ZIP code.', 'error');
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            // Geocode the ZIP code
            const userCoords = await geocodeZIP(zipInput);
            if (!userCoords) {
                showMessage('Could not find that ZIP code. Please try another.', 'error');
                searchBtn.disabled = false;
                searchBtn.textContent = 'Find Events';
                return;
            }

            // Filter and sort events
            const nearbyEvents = allEvents
                .map(event => ({
                    ...event,
                    distance: calculateDistance(
                        userCoords.lat, userCoords.lon,
                        event.lat, event.lon
                    )
                }))
                .filter(event => event.distance <= radius)
                .sort((a, b) => {
                    const dateA = new Date(parseDateTime(a.dtstart).date);
                    const dateB = new Date(parseDateTime(b.dtstart).date);
                    if (dateA !== dateB) return dateA - dateB;
                    return a.distance - b.distance;
                });

            displayResults(nearbyEvents, zipInput, radius);
            searchBtn.disabled = false;
            searchBtn.textContent = 'Find Events';
        });

        // Load events on page load
        window.addEventListener('load', async () => {
            const status = document.getElementById('dataStatus');
            status.innerHTML = '<div class="loading"><div class="spinner"></div>Loading and geocoding events...</div>';
            await fetchEvents();
        });
    </script>
</body>
</html>
